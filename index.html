<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet Data</title>

  <style>

    /* Avenir Font */
    @font-face {
      font-family: "Avenir LT W01_55 Roman";
      src: url('/assets/75c84254-5125-412c-bc24-56769ae3b627.woff2') format('woff2');
    }

    body {
      font-family: "Avenir LT W01_55 Roman", sans-serif;
      margin: 20px;
      background-color: #fafafa;
      color: #333;
    }

    h1 {
      color: #7535FB;
    }

    .container {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      width: 100%;
    }
    .buttons-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 150px;
    }
    .buttons-column button {
      padding: 10px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 4px;
    }
    .buttons-column button.active {
      background: #7535FB;
      color: white;
    }
    .content-column {
      flex: 1;
      width: 100%;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-button.active {
      background: #7535FB;
      color: white;
    }
    .content-section {
      display: none;
    }
    .content-section.active {
      display: block;
    }
    .collapsible {
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      background-color: #f0f0f0;
      border-radius: 4px;
      margin: 10px 0;
    }
    .collapsible:after {
      content: '\002B';
      float: right;
      margin-left: 5px;
    }
    .collapsible.active:after {
      content: "\2212";
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }

    .carousel {
      position: relative;
      width: 100%;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      padding: 1em;
      margin-top: 1em;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      min-height: 400px; /* Adjust this value based on your needs */
    }

    .carousel-slide {
      display: none;
      text-align: center;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      flex: 1;
      align-items: center;
    }

    .carousel-slide.active {
      display: flex;
    }

    .image-section {
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .image-section img {
      min-width: 50%;
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }

    .instruction-section {
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      text-align: center;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .instruction-section div {
      margin: 10px 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      text-align: center;
      max-width: 80%;
    }

    .carousel-controls {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 400px;
      margin: 20px auto 0;
    }

    .carousel-controls button {
      background-color: #7535FB;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .carousel-controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      color: #666;
    }

    .carousel-nav {
      display: flex;
      flex-direction: column;
      margin-right: 1rem;
      min-width: 200px;
    }

    .carousel-nav .nav-btn {
      padding: 8px 12px;
      margin-bottom: 6px;
      background-color: #eeeeee;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }

    .carousel-nav .nav-btn:hover {
      background-color: #7535FB;
      color: white;
    }

    .carousel-content {
      flex: 1;
      width: 100%;
    }
  </style>
</head>

<body>
  <h1>Data from Google Sheet</h1>
  <button class="collapsible">Show All Data</button>
  <div class="collapsible-content">
    <div id="sheet-data"></div>
  </div>

  <div class="container">
    <div class="buttons-column" id="topic-buttons"></div>
    <div class="content-column">
      <div id="os-buttons" class="tab-buttons"></div>
      <button class="collapsible">Show Instructions</button>
      <div class="collapsible-content">
        <div id="instruction-table" class="content-section active"></div>
      </div>
      <div id="column-carousel" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script>
    // Array to store all data from the spreadsheet
    const sheetDataArray = [];
    // URL of the Google Sheet with query parameters for JSON output
    const url = 'https://docs.google.com/spreadsheets/d/1SFM2os72yBHs1k3nQfY2TAr_pNVrU_ePNuDcGR_LJlQ/gviz/tq?tqx=out:json';

    let nameColumnIndex = -1;
    let osColumnIndex = -1;
    let typeColumnIndex = -1;
    let stepsColumnIndex = -1;
    

    /**
     * Displays instructions for selected rows in a table format, filtered by OS
     * @param {number[]} rowIndices - Array of row indices to display
     * @param {string} tabValue - Value to filter by in second column
     */
    function showContent(rowIndices, tabValue) {
      console.log("Showing content");
      // Update topic button active states
      const buttons = document.querySelectorAll('.buttons-column button');
      buttons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`button[data-rows="${rowIndices.join(',')}"]`).classList.add('active');

      // Update OS button active states
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`button[data-tab="${tabValue}"]`)?.classList.add('active');

      // Filter rows by OS value
      const filteredIndices = rowIndices.filter(index => 
        sheetDataArray[index][osColumnIndex] === tabValue
      );

      // Build table HTML
      const tableData = filteredIndices.map(rowIndex => {
        const rowData = [];
        for (let i = stepsColumnIndex; i < sheetDataArray[rowIndex].length; i++) {
          rowData.push(sheetDataArray[rowIndex][i]);
        }
        return rowData;
      });

      const tableType = filteredIndices.map(rowIndex => sheetDataArray[rowIndex][typeColumnIndex]);

      // Build table HTML starting with header row
      let html = '<table border="1">';
      tableData.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += '</tr>';
      });
      html += '</table>';
      
      // Update the DOM with the new instruction table
      document.getElementById('instruction-table').innerHTML = html;

      //console.table(tableData);

      // Build column-based carousel
const carouselContainer = document.getElementById("column-carousel");
const numCols = tableData[0]?.length || 0;


let carouselHTML = `
  <div style="display: flex;">
    <div class="carousel-nav">
      ${(() => {
        const headerRows = filteredIndices
          .filter(i => sheetDataArray[i][typeColumnIndex] === 'header')
          .map(i => sheetDataArray[i].slice(stepsColumnIndex));

        const headers = headerRows[0] || [];
        return headers.map((header, i) => `
          <button class="nav-btn" onclick="goToCarouselSlide(${i})">${header}</button>
        `).join('');
      })()}
    </div>
    <div class="carousel">`;

// Separate image and instruction rows
const imageRows = tableData.filter((row,index) => tableType[index] === 'image');
const instructionRows = tableData.filter((row,index) => tableType[index] === 'instruction');

for (let col = 0; col < numCols; col++) {
  carouselHTML += `
    <div class="carousel-slide${col === 0 ? ' active' : ''}" data-index="${col}">
      <div>
        <div class="image-section">
          ${imageRows.map(row => `<div>${row[col] || ''}</div>`).join('')}
        </div>
        <div class="instruction-section">
          ${instructionRows.map(row => `<div>${row[col] || ''}</div>`).join('')}
        </div>
      </div>
      <div class="carousel-controls">
        <button onclick="prevCarouselSlide()">←</button>
        <button onclick="nextCarouselSlide()">→</button>
      </div>
    </div>`;
}

carouselHTML += `
    </div> <!-- end carousel -->
  </div> <!-- end flex wrapper -->`;

carouselContainer.innerHTML = carouselHTML;
currentCarouselSlide = 0;
updateCarousel();  // Initialize button states

    }

    /**
     * Creates topic buttons for each unique value in the Name column
     * Groups rows with the same Name value together
     */
    function populateButtons() {
      console.log("Populating buttons");
      const buttonsContainer = document.getElementById('topic-buttons');
      const groupedRows = {};

      sheetDataArray.forEach((row, index) => {
        if (index === 0) return;
        const key = row[nameColumnIndex];
        if (!groupedRows[key]) {
          groupedRows[key] = [];
        }
        groupedRows[key].push(index);
      });

      // Create buttons for each topic group
      Object.entries(groupedRows).forEach(([text, indices], groupIndex) => {
        const button = document.createElement('button');
        button.textContent = text;
        button.setAttribute('data-rows', indices.join(','));
        
        // Get unique OS values for this group
        const tabValues = [...new Set(indices.map(i => sheetDataArray[i][osColumnIndex]))];
        const defaultTab = tabValues[0];
        
        button.onclick = () => {
          showContent(indices, defaultTab);
          populateTabs(indices);
        };
        
        if (groupIndex === 0) button.classList.add('active');
        buttonsContainer.appendChild(button);
      });
      
      // Show first group by default if any exist
      if (Object.keys(groupedRows).length > 0) {
        const firstIndices = groupedRows[Object.keys(groupedRows)[0]];
        const firstTabValue = sheetDataArray[firstIndices[0]][osColumnIndex];
        showContent(firstIndices, firstTabValue);
        populateTabs(firstIndices);
      }
    }

    /**
     * Creates OS buttons for unique values in second column
     * @param {number[]} rowIndices - Array of row indices to get OS values from
     */
    function populateTabs(rowIndices) {
      console.log("Populating tabs");
      const tabContainer = document.getElementById('os-buttons');
      tabContainer.innerHTML = '';
      
      // Get unique OS values from second column
      const tabValues = [...new Set(rowIndices.map(i => sheetDataArray[i][osColumnIndex]))];
      
      // Create OS buttons
      tabValues.forEach((tabValue, index) => {
        const button = document.createElement('button');
        button.textContent = tabValue;
        button.classList.add('tab-button');
        button.setAttribute('data-tab', tabValue);
        button.onclick = () => {showContent(rowIndices, tabValue);
        console.log(tabValue);};
        if (index === 0) button.classList.add('active');
        tabContainer.appendChild(button);
      });
    }

    /**
     * Renders the complete spreadsheet data as a table
     */
    function renderFullTable() {
      console.log("Rendering full table");
      let html = '<table border="1"><tr>';
      const numColumns = sheetDataArray[0]?.length || 0;

      // Create header row
      for (let i = 0; i < numColumns; i++) {
        html += `<th>Column ${i + 1}</th>`;
      }
      html += '</tr>';

      // Add all data rows
      sheetDataArray.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += '</tr>';
      });
      html += '</table>';

      // Update the DOM with the full table
      document.getElementById('sheet-data').innerHTML = html;
    }

    /**
     * Processes raw sheet data into usable format
     * Handles special cases like images and empty cells
     * @param {string} data - Raw JSON data from Google Sheets
     */
    function processSheetData(data) {
      console.log("Processing sheet data");
      // Parse the JSON data (removing Google's JSON-P wrapper)
      const jsonData = JSON.parse(data.substring(47).slice(0, -2));
      const rows = jsonData.table.rows;


      // Get the header row first and set indices
      const headerRow = rows[0].c.map(cell => cell?.v || '');
      sheetDataArray.push(headerRow);  // Add header row to sheetDataArray first

      // Set all column indices immediately using the header row
      for (let i = 0; i < headerRow.length; i++) {
        const header = headerRow[i].trim();
        switch(header) {
          case "Name":
            nameColumnIndex = i;
            break;
          case "OS":
            osColumnIndex = i;
            break;
          case "Type":
            typeColumnIndex = i;
            break;
          case "Steps":
            stepsColumnIndex = i;
            break;
        }
      }

      console.log("Column indices set:", {
        nameColumnIndex,
        osColumnIndex,
        typeColumnIndex,
        stepsColumnIndex
      });

      // Process the rest of the rows
      rows.slice(1).forEach(row => {
        // Skip rows where Type column is "imageDrive"
        if (row.c[typeColumnIndex]?.v === "imageDrive") {
          return;
        }

        let rowData = row.c.map((cell, index, array) => {
          const cellValue = cell?.v || '';
          // Check if Type column is "image"
          const isImageRow = array[typeColumnIndex]?.v === 'image';
          if (isImageRow && index > typeColumnIndex && cellValue) {
            return `<img src="${cellValue}" alt="Image">`;
          }
          return cellValue;
        });
        
        // Remove trailing empty cells
        while (rowData.length > 0 && rowData[rowData.length - 1] === '') {
          rowData.pop();
        }
        
        sheetDataArray.push(rowData);
      });

      renderFullTable();
    }

    let currentCarouselSlide = 0;

function updateCarousel() {
  const slides = document.querySelectorAll(".carousel-slide");
  const nextButton = document.querySelector(".carousel-controls button:last-child");
  const prevButton = document.querySelector(".carousel-controls button:first-child");
  
  slides.forEach((slide, i) => {
    slide.classList.toggle("active", i === currentCarouselSlide);
  });

  // Disable next button if we're at the last slide
  if (nextButton) {
    nextButton.disabled = currentCarouselSlide === slides.length - 1;
  }

  // Disable previous button if we're at the first slide
  if (prevButton) {
    prevButton.disabled = currentCarouselSlide === 0;
  }
}

function goToCarouselSlide(index) {
  currentCarouselSlide = index;
  updateCarousel();
}

function prevCarouselSlide() {
  const slides = document.querySelectorAll(".carousel-slide");
  if (currentCarouselSlide > 0) {
    currentCarouselSlide--;
    updateCarousel();
  }
}

function nextCarouselSlide() {
  const slides = document.querySelectorAll(".carousel-slide");
  if (currentCarouselSlide < slides.length - 1) {
    currentCarouselSlide++;
    updateCarousel();
  }
}


    // Initialize buttons once data is loaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOMContentLoaded");
      const checkData = setInterval(() => {
        if (sheetDataArray.length > 0) {
          populateButtons();
          clearInterval(checkData);
        }
      }, 100);

      // Add collapsible functionality to both buttons
      document.querySelectorAll(".collapsible").forEach(coll => {
        coll.addEventListener("click", function() {
          this.classList.toggle("active");
          const content = this.nextElementSibling;
          if (content.style.maxHeight) {
            content.style.maxHeight = null;
          } else {
            content.style.maxHeight = content.scrollHeight + "px";
          }
        });
      });
    });

    // Fetch and process the spreadsheet data
    fetch(url)
      .then(response => response.text())
      .then(processSheetData)
      .catch(error => console.error('Error fetching data:', error));
  </script>
</body>
</html>
